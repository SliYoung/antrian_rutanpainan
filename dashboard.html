<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Antrian | Rutan Kelas IIB Painan</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{font-family:Inter,sans-serif;background:#f3f4f6;margin:0}

/* HEADER */
.header{
  background:linear-gradient(135deg,#1e3a8a,#2563eb);
  color:#fff;
  padding:18px 22px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.brand{display:flex;align-items:center;gap:12px}
.brand img{width:42px}
.brand h1{font-size:18px;margin:0}
.logout{
  background:#dc2626;
  border:none;
  padding:10px 16px;
  color:#fff;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
}

/* CONTENT */
.container{padding:24px}

/* STATS */
.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:16px;
  margin-bottom:20px;
}
.stat{
  background:#fff;
  padding:18px;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.1);
  text-align:center;
}
.stat h3{margin:0;color:#6b7280;font-size:14px}
.stat h1{margin:10px 0 0;font-size:32px;color:#1e3a8a}

/* CARD */
.card{
  background:#fff;
  border-radius:16px;
  box-shadow:0 15px 30px rgba(0,0,0,.1);
  padding:20px;
}
h2{text-align:center;color:#1e3a8a}

/* TABLE */
table{width:100%;border-collapse:collapse;margin-top:16px}
th,td{
  padding:12px;
  font-size:14px;
  text-align:center;
  border-bottom:1px solid #e5e7eb;
}
th{background:#2563eb;color:#fff}
.status-menunggu{color:#d97706;font-weight:600}
.status-dipanggil{color:#059669;font-weight:600}

button{
  padding:7px 14px;
  background:#2563eb;
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
button:disabled{background:#9ca3af}
</style>
</head>

<body>

<script>
if(localStorage.getItem("login")!=="true"){
  location.href="login.html";
}
</script>

<!-- HEADER -->
<div class="header">
  <div class="brand">
    <img src="https://i.imgur.com/GifnqrQ.png">
    <h1>Dashboard Antrian Rutan Kelas IIB Painan</h1>
  </div>
  <button class="logout" onclick="logout()">Logout</button>
</div>

<div class="container">

<!-- STATS -->
<div class="stats">
  <div class="stat"><h3>Total Hari Ini</h3><h1 id="total">0</h1></div>
  <div class="stat"><h3>Dipanggil</h3><h1 id="dipanggil">0</h1></div>
  <div class="stat"><h3>Menunggu</h3><h1 id="menunggu">0</h1></div>
</div>

<!-- KONTROL SUARA -->
<div style="display:flex;justify-content:space-between;margin-bottom:12px">
  <button id="btnSound" onclick="aktifkanSuara()"
    style="background:#059669;padding:10px 16px;border-radius:10px;font-weight:600">
    ðŸ”Š Aktifkan Suara
  </button>

  <select id="voiceType" style="padding:6px;border-radius:6px">
    <option value="female">Wanita</option>
    <option value="male">Pria</option>
  </select>
</div>

<!-- TABLE -->
<div class="card">
<h2>Data Antrian Kunjungan</h2>
<table>
<thead>
<tr>
<th>No</th>
<th>Nama</th>
<th>WBP</th>
<th>Tanggal</th>
<th>Antrian</th>
<th>Status</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="dataAntrian"></tbody>
</table>
</div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbwWSDyO29MhHfwED8-NGV5PuvW9wn5Hl9pltHvzitMYZZ10WFBaKoyzGhRkPb1jauvU/exec";

/* ðŸ”Š VOICE */
let voicesReady=false;
let VOICES=[];

speechSynthesis.onvoiceschanged=()=>{
  VOICES=speechSynthesis.getVoices();
};

/* ðŸ”“ AKTIFKAN SUARA */
function aktifkanSuara(){
  speechSynthesis.cancel();
  speechSynthesis.resume(); // ðŸ”¥ PENTING

  const u=new SpeechSynthesisUtterance(
    "Selamat datang di Rumah tahanan Kelas 2B Painan, Sistem antrian layanan akan segera dimulai.Mohon menunggu dan memperhatikan nomor antrian yang akan dipanggil sesuai urutan.Terima kasih."
  );
  u.lang="id-ID";
  speechSynthesis.speak(u);

  voicesReady=true;
  btnSound.innerText="âœ… Suara Aktif";
  btnSound.disabled=true;
}

/* ðŸ”Š SUARA PANGGIL */
function suara(antrian,nama){
  if(!voicesReady){
    alert("Aktifkan suara terlebih dahulu");
    return;
  }

  let v=VOICES.find(v=>v.lang.includes("id")) || VOICES[0];

  const msg=new SpeechSynthesisUtterance(
    `Nomor antrian ${antrian}, atas nama ${nama}, silakan menuju PTSP`
  );
  msg.voice=v;
  msg.lang="id-ID";
  msg.rate=0.85;
  msg.pitch=voiceType.value==="male"?0.8:1.2;

  speechSynthesis.cancel();
  speechSynthesis.speak(msg);
}

/* ðŸ“Š LOAD DATA */
function loadData(){
fetch(API_URL)
.then(r=>r.json())
.then(data=>{
  let t=0,d=0,m=0;
  dataAntrian.innerHTML="";
  data.forEach((x,i)=>{
    t++; x.status==="Dipanggil"?d++:m++;
    dataAntrian.innerHTML+=`
    <tr>
      <td>${i+1}</td>
      <td>${x.nama}</td>
      <td>${x.wbp}</td>
      <td>${x.tanggal}</td>
      <td><b>${x.antrian}</b></td>
      <td class="status-${x.status.toLowerCase()}">${x.status}</td>
      <td>
        ${x.status==="Menunggu"
        ? `<button onclick="panggil(${x.id},'${x.antrian}','${x.nama}')">Panggil</button>`
        : `<button disabled>Dipanggil</button>`}
      </td>
    </tr>`;
  });
  total.innerText=t;
  dipanggil.innerText=d;
  menunggu.innerText=m;
});
}

/* ðŸ“¢ PANGGIL (SUARA DULU BARU FETCH) */
function panggil(row,antrian,nama){
  suara(antrian,nama); // ðŸ”¥ HARUS DULU

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({action:"panggil",row})
  }).then(()=>loadData());
}

function logout(){
localStorage.removeItem("login");
location.href="login.html";
}

loadData();
setInterval(loadData,5000);
</script>

</body>
</html>
