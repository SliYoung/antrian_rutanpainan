<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Antrian | Rutan Kelas IIB Painan</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/png" href="https://i.imgur.com/GifnqrQ.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{font-family:Inter,sans-serif;background:#f3f4f6;margin:0}

.header{
  background:linear-gradient(135deg,#1e3a8a,#2563eb);
  color:#fff;
  padding:18px 22px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.brand{display:flex;align-items:center;gap:12px}
.brand img{width:42px}
.brand h1{font-size:18px;margin:0}
.logout{
  background:#dc2626;
  border:none;
  padding:10px 16px;
  color:#fff;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
}

.container{padding:24px}

.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:16px;
  margin-bottom:20px;
}
.stat{
  background:#fff;
  padding:18px;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.1);
  text-align:center;
}
.stat h3{margin:0;color:#6b7280;font-size:14px}
.stat h1{margin:10px 0 0;font-size:32px;color:#1e3a8a}

.card{
  background:#fff;
  border-radius:16px;
  box-shadow:0 15px 30px rgba(0,0,0,.1);
  padding:20px;
}
h2{text-align:center;color:#1e3a8a}

table{width:100%;border-collapse:collapse;margin-top:16px}
th,td{
  padding:12px;
  font-size:14px;
  text-align:center;
  border-bottom:1px solid #e5e7eb;
}
th{background:#2563eb;color:#fff}

.status-menunggu{color:#d97706;font-weight:600}
.status-selesai{color:#6b7280;font-weight:600}

button{
  padding:7px 14px;
  background:#2563eb;
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
button:disabled{background:#9ca3af}
</style>
</head>

<body>

<script>
if(localStorage.getItem("login")!=="true"){
  location.href="login.html";
}
</script>

<!-- ðŸ”” AUDIO BEL -->
<audio id="audioBel" preload="auto">
  <source src="ringtone Hp bell bandara.mp3" type="audio/mpeg">
</audio>

<div class="header">
  <div class="brand">
    <img src="https://i.imgur.com/GifnqrQ.png">
    <h1>Dashboard Antrian Rutan Kelas IIB Painan</h1>
  </div>
  <button class="logout" onclick="logout()">Logout</button>
</div>

<div class="container">

<div class="stats">
  <div class="stat"><h3>Total Hari Ini</h3><h1 id="total">0</h1></div>
  <div class="stat"><h3>Menunggu</h3><h1 id="menunggu">0</h1></div>
  <div class="stat"><h3>Selesai</h3><h1 id="selesaiCount">0</h1></div>
</div>

<div style="display:flex;gap:10px;justify-content:space-between;margin-bottom:12px">
  <div>
    <button id="btnSound" onclick="aktifkanSuara()"
      style="background:#059669;padding:10px 16px;border-radius:10px;font-weight:600">
      ðŸ”Š Aktifkan Suara
    </button>

    <button onclick="pengumumanPelayanan()"
      style="background:#7c3aed;padding:10px 16px;border-radius:10px;font-weight:600;margin-left:8px">
      ðŸ“¢ Pengumuman Pelayanan
    </button>
  </div>

  <select id="voiceType" style="padding:6px;border-radius:6px">
    <option value="female">Wanita</option>
    <option value="male">Pria</option>
  </select>
</div>

<div class="card">
<h2>Data Antrian Kunjungan</h2>
<table>
<thead>
<tr>
<th>No</th>
<th>Nama</th>
<th>WBP</th>
<th>Tanggal</th>
<th>Antrian</th>
<th>Status</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="dataAntrian"></tbody>
</table>
</div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbyCoGTPVM2RRzxTve3ik1PQRS78VHYif1-33Lcg8XEKbRdaxOW02JxGGQxmItnNbeE2/exec";

let voicesReady=false;
let VOICES=[];

speechSynthesis.onvoiceschanged=()=>{
  VOICES = speechSynthesis.getVoices();
};

// ðŸ”” BEL PEMBUKA
function aktifkanSuara(){
  const bel=document.getElementById("audioBel");
  bel.currentTime=0;
  bel.play();

  setTimeout(()=>{
    bel.pause();
    bel.currentTime=0;

    const u=new SpeechSynthesisUtterance(
      "Selamat datang di Rumah Tahanan Negara Kelas 2B Painan.Demi kelancaran dan kenyamanan bersama, kami akan segera memulai layanan antrian.Silakan memperhatikan layar informasi dan menunggu hingga nomor antrian Anda dipanggil.Terima kasih atas perhatian dan kerja samanya."
    );
    u.lang="id-ID";
    u.rate=0.9;

    speechSynthesis.cancel();
    speechSynthesis.speak(u);

    voicesReady=true;
    btnSound.innerText="âœ… Suara Aktif";
    btnSound.disabled=true;
  },5000);
}

// ðŸ“¢ PENGUMUMAN PELAYANAN (BEL + TEKS)
function pengumumanPelayanan(){
  if(!voicesReady){
    alert("Aktifkan suara terlebih dahulu");
    return;
  }

  const bel=document.getElementById("audioBel");
  bel.currentTime=0;
  bel.play();

  setTimeout(()=>{
    bel.pause();
    bel.currentTime=0;

    let v=VOICES.find(v=>v.lang.includes("id"))||VOICES[0];

    const msg=new SpeechSynthesisUtterance(
      "Mohon Perhatian. Demi menjaga keamanan dan ketertiban di Rumah Tahanan Negara Kelas 2B Painan, seluruh pengunjung dilarang membawa senjata tajam, narkotika, alat komunikasi, rokok, uang tunai minuman keras, serta barang berbahaya lainnya. Mohon patuhi seluruh ketentuan yang berlaku. Terima kasih."
    );
    msg.lang="id-ID";
    msg.rate=0.85;
    msg.voice=v;

    speechSynthesis.cancel();
    speechSynthesis.speak(msg);
  },5000);
}

// ðŸ“£ PANGGIL ANTRIAN (TANPA BEL)
function suara(antrian){
  if(!voicesReady){
    alert("Aktifkan suara terlebih dahulu");
    return;
  }

  let v=VOICES.find(v=>v.lang.includes("id"))||VOICES[0];

  const msg=new SpeechSynthesisUtterance(
    `Nomor antrian ${antrian}, silakan menuju keruangan pelayanan,, PTSP`
  );
  msg.lang="id-ID";
  msg.rate=0.85;
  msg.pitch=voiceType.value==="male"?0.8:1.2;
  msg.voice=v;

  speechSynthesis.cancel();
  speechSynthesis.speak(msg);
}

function loadData(){
fetch(API_URL).then(r=>r.json()).then(data=>{
  let t=0,m=0,s=0;
  dataAntrian.innerHTML="";
  data.forEach((x,i)=>{
    t++; if(x.status==="Menunggu") m++; if(x.status==="Selesai") s++;
    dataAntrian.innerHTML+=`
<tr>
<td>${i+1}</td>
<td>${x.nama}</td>
<td>${x.wbp}</td>
<td>${x.tanggal}</td>
<td><b>${x.antrian}</b></td>
<td class="status-${x.status.toLowerCase()}">${x.status}</td>
<td>
${x.status!=="Selesai"?`
<button onclick="suara('${x.antrian}')" style="background:#059669">ðŸ”Š Panggil</button><br><br>
<button onclick="selesai(${x.id})" style="background:#6b7280">âœ… Selesai</button>
`:`
<button disabled>ðŸ”‡ Panggil</button><br><br>
<button disabled>Selesai</button>`}
</td>
</tr>`;
  });
  total.innerText=t;
  menunggu.innerText=m;
  selesaiCount.innerText=s;
});
}

function selesai(row){
  fetch(API_URL,{method:"POST",body:JSON.stringify({action:"selesai",row})})
  .then(()=>loadData());
}

function logout(){
  localStorage.removeItem("login");
  location.href="login.html";
}

loadData();
setInterval(loadData,5000);
</script>

</body>
</html>
